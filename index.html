<!DOCTYPE html>
<html>
<div id="chartContainer">
  <script src="http://d3js.org/d3.v4.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>

  <style>
    h3 {
      text-align: center;
    }
  </style>

	<script type="text/javascript">
		d3.select('#chartContainer')
            	.append('h3')
            	.text("Yearly Median Actual Return Vs. Median Prosper Loans Estimated Return for each Prosper Rating");

        d3.select('body')
            .append('h4')
            .text("Loans included in the plot are only those with proser loan ratings and estimated returns");

      	var svg = dimple.newSvg("#chartContainer", 810, 610);
      	d3.csv("Prosper_Loans_Actual_Return_2.csv", function (data) { 
      		

		// Filter for years
		data = dimple.filterData(data, "ListingCreationDateYear", [
		  "2009", "2010", "2011", "2012", "2013"
		]);

		// Create the indicator chart on the right of the main chart
		var indicator = new dimple.chart(svg, data);

		// Pick blue as the default and orange for the selected month
		var defaultColor = indicator.defaultColors[0];
		var indicatorColor = indicator.defaultColors[2];

		// The frame duration for the animation in milliseconds
		var frame = 2000;

		var firstTick = true;

		// Place the indicator bar chart to the right
		indicator.setBounds(634, 70, 153, 311);

		// Add dates along the y axis
		var y = indicator.addCategoryAxis("y", "ListingCreationDateYear");
		y.addOrderRule("Date");

		// Use sales for bar size and hide the axis
		var x = indicator.addMeasureAxis("x", "Total_Amount_of_Loans");
		x.hidden = true;

		// Add the bars to the indicator and add event handlers
		var s = indicator.addSeries(null, dimple.plot.bar);

		s.addEventHandler("click", onClick);
		// Draw the side chart
		indicator.draw();

		// Remove the title from the y axis
		y.titleShape.remove();

		// Remove the lines from the y axis
		y.shapes.selectAll("line,path").remove();

		// Move the y axis text inside the plot area
		y.shapes.selectAll("text")
		    .style("text-anchor", "start")
		    .style("font-size", "14px")
		    .attr("transform", "translate(12, 0.5)");

		// This block simply adds the legend title. I put it into a d3 data
		// object to split it onto 2 lines.  This technique works with any
		// number of lines, it isn't dimple specific.
		svg.selectAll("title_text")
		    .data(["Click bar to select",
		        "and pause. Click again",
		        "to resume animation.",
		        "Bar size equate to total",
		        "yearly loans"])
		    .enter()
		    .append("text")
		    .attr("x", 635)
		    .attr("y", function (d, i) { return 15 + i * 12; })
			.style("font-family", "sans-serif")
			.style("font-size", "14px")
			.style("color", "Black")
			.text(function (d) { return d; });

		svg.selectAll("title_text_proserrating")
		    .data(["Prosper Loan Rating From Best to Worst (AA-HR)"])
		    .enter()
		    .append("text")
		    .attr("x", 70)
		    .attr("y", function (d, i) { return 15 + i * 12; })
			.style("font-family", "sans-serif")
			.style("font-size", "14px")
			.style("color", "Black")
			.text(function (d) { return d; });



		// Manually set the bar colors
		s.shapes
			.attr("rx", 10)
			.attr("ry", 10)
			.style("fill", function (d) { return (d.y === '2009' ? indicatorColor.fill : defaultColor.fill) })
			.style("stroke", function (d) { return (d.y === '2009' ? indicatorColor.stroke : defaultColor.stroke) })
			.style("opacity", 0.4);

		// Draw the main chart
		var bubbles = new dimple.chart(svg, data);
		bubbles.setBounds(60, 50, 555, 510)
		x = bubbles.addMeasureAxis("x", "Median_Estimated_Return");
		x.overrideMax =0.2;
		x.fontSize = "14px"
		y = bubbles.addMeasureAxis("y", "Median_Actual_Return");
		y.overrideMax =0.2;
		y.fontSize="14px"
		bubbles.addMeasureAxis("z", "Total_Amount_of_Loans")
		bubbles.addSeries("ProsperRating.Alpha", dimple.plot.bubble)
		var myLegend = bubbles.addLegend(60, 30, 410, 60);

		//Order proser loan rating legend from worst to best 
		myLegend._getEntries = function () {
			var entries = [];
			if (this.series) {
			    this.series.forEach(function (series) {
			        var data = series._positionData;
			        data.forEach(function (row) {
			            var index = -1,
			                j,
			                field = ((series.plot.grouped && !series.x._hasCategories() && !series.y._hasCategories() && row.aggField.length < 2 ? "All" : row.aggField.slice(-1)[0]));
			            for (j = 0; j < entries.length; j += 1) {
			                if (entries[j].key === field) {
			                    index = j;
			                    break;
			                }
			            }
			            if (index === -1 && series.chart._assignedColors[field]) {
			                entries.push({
			                    key: field,
			                    fill: series.chart._assignedColors[field].fill,
			                    stroke: series.chart._assignedColors[field].stroke,
			                    opacity: series.chart._assignedColors[field].opacity,
			                    series: series,
			                    aggField: row.aggField
			                });
			                index = entries.length - 1;
			                }
			            });
			        }, this);
			    }

				
		        // Sort Alphabetically
		        entries.sort(function(a, b){var x = a.key, y = b.key;
		        	return y == "AA" ? 1 : x < y ? -1 : x > y ? 1 : 0;
					});
		        
		        return entries;
		    };
		// Add a storyboard to the main chart and set the tick event
		var story = bubbles.setStoryboard("ListingCreationDateYear", onTick);
		// Change the frame duration
		story.frameDuration = frame;
		// Order the storyboard by date
		story.addOrderRule("Date");

		// Draw the bubble chart
		bubbles.draw();

		svg.selectAll("classify_text_graph")
		    .data(["Above 1:1 Dashed Line Median Actual Return > Median Estimated Return"])
		    .enter()
		    .append("text")
		    .attr("x", 70)
		    .attr("y", function (d, i) { return 70 + i * 12; })
			.style("font-family", "sans-serif")
			.style("font-size", "14px")
			.style("color", "Black")
			.text(function (d) { return d; });
		// Orphan the legends as they are consistent but by default they
		// will refresh on tick
		bubbles.legends = [];
		// Remove the storyboard label because the chart will indicate the
		// current month instead of the label
		story.storyLabel.remove();

		// On click of the side chart
		function onClick(e) {
			// Pause the animation
			story.pauseAnimation();
			// If it is already selected resume the animation
			// otherwise pause and move to the selected month
			if (e.yValue === story.getFrameValue()) {
				story.startAnimation();
			} else {
				story.goToFrame(e.yValue);
				story.pauseAnimation();
			}
		}

		// On tick of the main charts storyboard
		function onTick(e) {
		  if (!firstTick) {
		      // Color all shapes the same
		    s.shapes
				.transition()
				.duration(frame / 2)
				.style("fill", function (d) { return (d.y === e ? indicatorColor.fill : defaultColor.fill) })
				.style("stroke", function (d) { return (d.y === e ? indicatorColor.stroke : defaultColor.stroke) });
		  }

			firstTick = false;

			svg.append("line")
				.attr("x1",x._scale(0))
				.attr("x2", x._scale(1))
				.attr("y1", y._scale(0))
				.attr("y2", y._scale(1))
				.style("stroke", "gray")
				.style("stroke-dasharray", "3");
		}
      });
  </script>
</div>
</html>